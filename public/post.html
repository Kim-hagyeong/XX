<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>í¬ìŠ¤íŠ¸ ëª©ë¡</title>
  </head>
  <body>
    <h2>í¬ìŠ¤íŠ¸ ëª©ë¡</h2>

    <!-- ğŸ”¸ ê¸€ ì‘ì„± í¼ -->
    <form id="post-form">
      <input type="hidden" id="userid" />
      <input type="hidden" id="name" />
      <textarea id="text" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" required></textarea>
      <button type="submit">ê¸€ ë“±ë¡</button>
    </form>

    <hr />

    <!-- ğŸ”¸ ê¸€ ëª©ë¡ -->
    <ul id="post-list"></ul>

    <script>
      // ğŸ” JWT ë””ì½”ë“œ (Base64 URL ë””ì½”ë”©)
      function parseJwt(token) {
        try {
          const payload = token.split(".")[1];
          return JSON.parse(
            atob(payload.replace(/-/g, "+").replace(/_/g, "/"))
          );
        } catch (e) {
          return null;
        }
      }

      const token = localStorage.getItem("token");
      if (!token) {
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        window.location.href = "login.html";
      }

      const user = parseJwt(token);
      if (!user) {
        alert("ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.");
        localStorage.removeItem("token");
        window.location.href = "login.html";
      }

      // ğŸ”¸ ì‚¬ìš©ì ì •ë³´ ìë™ ì±„ìš°ê¸°
      document.getElementById("userid").value = user.userid;
      document.getElementById("name").value = user.name;

      // ğŸ”¸ ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
      async function loadPosts() {
        const res = await fetch("http://127.0.0.1:8080/posts", {
          headers: { Authorization: `Bearer ${token}` },
        });
        const result = await res.json();

        const postList = document.getElementById("post-list");
        postList.innerHTML = "";

        result.posts.forEach((post) => {
          const li = document.createElement("li");

          const isMine = post.userid === user.userid;

          li.innerHTML = `
          <strong>${post.name}</strong>: 
          <span>${post.text}</span>
          ${
            isMine
              ? `
            <button onclick="editPost(${post.id}, this)">âœï¸ ìˆ˜ì •</button>
            <button onclick="deletePost(${post.id})">ğŸ—‘ ì‚­ì œ</button>
          `
              : ""
          }
        `;

          postList.appendChild(li);
        });
      }

      // ğŸ”¸ ê¸€ ë“±ë¡
      document
        .getElementById("post-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const text = document.getElementById("text").value;

          const data = {
            userid: user.userid,
            name: user.name,
            text,
          };

          const res = await fetch("http://127.0.0.1:8080/posts", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(data),
          });

          if (res.ok) {
            document.getElementById("text").value = "";
            loadPosts(); // ê°±ì‹ 
          } else {
            alert("ë“±ë¡ ì‹¤íŒ¨");
          }
        });

      // ğŸ”¸ ê¸€ ìˆ˜ì •
      async function editPost(id, button) {
        const li = button.closest("li");
        const span = li.querySelector("span");
        const oldText = span.innerText;

        const newText = prompt("ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”:", oldText);
        if (!newText) return;

        const res = await fetch(`http://127.0.0.1:8080/posts/${id}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ text: newText }),
        });

        if (res.ok) {
          loadPosts();
        } else {
          alert("ìˆ˜ì • ì‹¤íŒ¨");
        }
      }

      // ğŸ”¸ ê¸€ ì‚­ì œ
      async function deletePost(id) {
        if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        const res = await fetch(`http://127.0.0.1:8080/posts/${id}`, {
          method: "DELETE",
          headers: { Authorization: `Bearer ${token}` },
        });

        if (res.ok) {
          loadPosts();
        } else {
          alert("ì‚­ì œ ì‹¤íŒ¨");
        }
      }

      // ìµœì´ˆ í˜¸ì¶œ
      loadPosts();
    </script>
  </body>
</html>
